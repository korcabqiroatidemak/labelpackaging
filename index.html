<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Label Packaging EBTAQ | Header Top Logo</title>
    <style>
        /* Ukuran Kertas F4 (215mm x 330mm) */
        @page { size: 215mm 330mm; margin: 0; }
        body { 
            margin: 0; padding: 0; background-color: #f0f2f5; 
            font-family: "Arial", sans-serif;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* ================= PANEL KONTROL ================= */
        .control-panel {
            background: #fff; width: 210mm; margin: 20px auto;
            padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            text-align: center; border: 1px solid #ddd;
        }
        .control-panel h2 { color: #007bff; margin-bottom: 25px; }
        .row { display: flex; gap: 20px; margin-bottom: 20px; justify-content: center; align-items: flex-end; }
        .group { display: flex; flex-direction: column; gap: 8px; text-align: left; }
        label { font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; }
        
        input, select { 
            height: 42px; padding: 0 12px; border: 1.5px solid #ccc; border-radius: 6px; 
            box-sizing: border-box; font-size: 14px; background: #fafafa;
        }

        input[type="file"] { padding: 0; display: flex; align-items: center; cursor: pointer; background: #fff; }
        input[type="file"]::-webkit-file-upload-button {
            height: 42px; margin: -1.5px 10px -1.5px -1.5px; padding: 0 15px;
            border: none; border-right: 1.5px solid #ccc; background: #eee;
            color: #333; font-weight: bold; cursor: pointer;
        }

        .btn-gen { 
            background: #28a745; color: white; border: none; padding: 0 35px; 
            height: 42px; font-weight: bold; cursor: pointer; border-radius: 6px; 
        }

        /* ================= GRID SISTEM (2x2 F4) ================= */
        .page-sheet {
            width: 215mm; height: 330mm; margin: 0 auto;
            background-color: white; display: grid;
            /* Membagi rata 215mm dan 330mm */
            grid-template-columns: 107.5mm 107.5mm; 
            grid-template-rows: 165mm 165mm;
            box-sizing: border-box; page-break-after: always;
        }

        .label-card {
            box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
            /* Margin aman 0.5cm dari tepi grid */
            padding: 5mm; 
            border: 0.1mm dashed #ccc; /* Garis pandu potong */
        }

        .card-inner {
            width: 100%; height: 100%; border: 0.6mm solid #000; padding: 3mm;
            box-sizing: border-box; background: #fff; display: flex; flex-direction: column;
        }

        /* HEADER DENGAN LOGO DI ATAS */
        .header-content { text-align: center; margin-bottom: 5px; }
        .logo-top { width: 45px; height: 45px; margin-bottom: 5px; }
        .instansi-title { margin: 0; font-size: 8.5pt; font-weight: bold; line-height: 1.2; }
        .instansi-subtitle { margin: 0; font-size: 10pt; font-weight: bold; text-transform: uppercase; line-height: 1.2; }
        
        .header-address { 
            margin-top: 5px; padding: 3px 0; border-top: 1.2pt solid #000;
            font-size: 6.2pt; text-align: center; line-height: 1.2;
            border-bottom: 2.5pt double #000; margin-bottom: 8px;
            white-space: nowrap; overflow: hidden;
        }

        .title-section { text-align: center; margin-bottom: 6px; }
        .card-title { font-size: 14pt; font-weight: 900; margin: 0; }
        .card-periode { font-size: 9.5pt; font-weight: bold; }

        /* TABEL DATA */
        .info-table { width: 100%; font-size: 10pt; border-collapse: collapse; margin-bottom: 5px; }
        .info-table td { vertical-align: top; padding: 1.5px 0; }
        .label-cell { width: 85px; font-weight: bold; }

        /* STATISTIK */
        .stat-box { display: flex; border: 1.5px solid #000; margin-bottom: 8px; }
        .stat-item { flex: 1; text-align: center; border-right: 1.5px solid #000; padding: 3px; }
        .stat-item:last-child { border-right: none; }
        .stat-val { display: block; font-size: 13pt; font-weight: bold; }
        .stat-lbl { font-size: 7pt; font-weight: bold; }

        /* CHECKLIST */
        .checklist-title { font-size: 8.5pt; font-weight: bold; margin-bottom: 3px; text-decoration: underline; }
        .check-item { display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 2px; border-bottom: 0.1mm solid #f0f0f0; }
        .check-box { width: 12px; height: 12px; border: 1.5px solid #000; margin-right: 8px; display: inline-block; vertical-align: middle; }

        .footer-date { margin-top: auto; font-size: 8pt; text-align: right; font-style: italic; border-top: 1px dashed #ccc; padding-top: 3px; }

        @media print {
            body { background: none; }
            .control-panel { display: none !important; }
            .page-sheet { margin: 0; border: none; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <h2>LABEL PACKAGING</h2>
    <div class="row">
        <div class="group" style="flex: 1.6;">
            <label>1. Pilih Sumber Data CSV</label>
            <input type="file" id="csv-input" accept=".csv" onchange="processData()" style="width: 100%;">
        </div>
        <div class="group" style="flex: 1;">
            <label>2. Periode</label>
            <input type="text" id="cfg-periode" placeholder="Contoh: TAHAP II 2025" style="width: 100%;">
        </div>
    </div>
    <div class="row">
        <div class="group">
            <label>3. Tanggal EBTAQ</label>
            <input type="date" id="ebtaq-date-picker">
        </div>
        <div class="group">
            <label>4. Posisi Awal Cetak</label>
            <select id="start-pos" style="width: 180px;">
                <option value="1">1 (Kiri Atas)</option>
                <option value="2">2 (Kanan Atas)</option>
                <option value="3">3 (Kiri Bawah)</option>
                <option value="4">4 (Kanan Bawah)</option>
            </select>
        </div>
        <div class="group">
            <label>&nbsp;</label>
            <button class="btn-gen" onclick="generateLabels()">GENERATE LABEL</button>
        </div>
    </div>
</div>

<div id="render-area"></div>

<script>
    let groupedData = [];
    let lMemory = JSON.parse(localStorage.getItem('ebtaq_v19_mem')) || {};

    window.onload = () => {
        if(localStorage.getItem('cfg-periode')) document.getElementById('cfg-periode').value = localStorage.getItem('cfg-periode');
        document.getElementById('ebtaq-date-picker').value = new Date().toISOString().split('T')[0];
    };

    function processData() {
        const file = document.getElementById('csv-input').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
            const headers = lines[0].split(';').map(h => h.replace(/"/g, '').trim().toUpperCase());
            const raw = lines.slice(1).map(line => {
                const cols = line.split(';').map(c => c.replace(/"/g, '').trim());
                let obj = {}; headers.forEach((v, i) => { if(v) obj[v] = cols[i]; });
                return obj;
            });
            const schools = [...new Set(raw.map(d => d['ASAL LEMBAGA']))];
            groupedData = schools.map(s => {
                const members = raw.filter(d => d['ASAL LEMBAGA'] === s);
                const lulus = members.filter(m => (m['L / TL'] || m['L/TL']) === "L").length;
                return { nama: s, total: members.length, l: lulus, tl: members.length - lulus };
            });
            alert("Berhasil memproses " + groupedData.length + " Lembaga.");
        };
        reader.readAsText(file);
    }

    function formatDateIndo(dateStr) {
        if(!dateStr) return "....................";
        const d = new Date(dateStr);
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function generateLabels() {
        if(groupedData.length === 0) return alert("Pilih file CSV dahulu!");
        const startPos = parseInt(document.getElementById('start-pos').value);
        const ebtaqDate = formatDateIndo(document.getElementById('ebtaq-date-picker').value);
        const periode = document.getElementById('cfg-periode').value || "....................";
        localStorage.setItem('cfg-periode', periode);
        const renderArea = document.getElementById('render-area');
        renderArea.innerHTML = '';
        let finalItems = [];
        for(let i = 1; i < startPos; i++) { finalItems.push(null); }
        finalItems = [...finalItems, ...groupedData];

        for (let i = 0; i < finalItems.length; i += 4) {
            const pageData = finalItems.slice(i, i + 4);
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-sheet';
            pageData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'label-card';
                if(item) {
                    const mem = lMemory[item.nama] || { alias: item.nama, head: "....................", korcam: "...................." };
                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="header-content">
                                <img src="QIRAATI.png" class="logo-top">
                                <p class="instansi-title">KOORDINATOR PENDIDIKAN AL-QURâ€™AN</p>
                                <p class="instansi-subtitle">METODE QIROATI CABANG DEMAK</p>
                            </div>
                            <div class="header-address">
                                Sekretariat : Jl. Sunan Kalijaga No. 35 Betengan Bintoro Demak Hp. 0896-0898-6635
                            </div>
                            <div class="title-section">
                                <div class="card-title">DOKUMEN EBTAQ</div>
                                <div class="card-periode">PERIODE: ${periode}</div>
                            </div>
                            <table class="info-table">
                                <tr><td class="label-cell">LEMBAGA</td><td style="width:10px">:</td><td><strong>${mem.alias}</strong></td></tr>
                                <tr><td class="label-cell">KEPALA</td><td>:</td><td>${mem.head}</td></tr>
                                <tr><td class="label-cell">KORCAM</td><td>:</td><td>${mem.korcam}</td></tr>
                                <tr><td class="label-cell">HP/WA</td><td>:</td><td>.........................................</td></tr>
                            </table>
                            <div class="stat-box">
                                <div class="stat-item"><span class="stat-val">${item.total}</span><span class="stat-lbl">Peserta</span></div>
                                <div class="stat-item"><span class="stat-val">${item.l}</span><span class="stat-lbl">Lulus</span></div>
                                <div class="stat-item"><span class="stat-val">${item.tl}</span><span class="stat-lbl">Tdk Lulus</span></div>
                            </div>
                            <div class="checklist-title">CHECKLIST ISI PAKET:</div>
                            <div class="check-item"><span><span class="check-box"></span> Cover Ijazah</span> <span>${item.l} exp</span></div>
                            <div class="check-item"><span><span class="check-box"></span> Ijazah (Hlm. Nilai)</span> <span>${item.l} exp</span></div>
                            <div class="check-item"><span><span class="check-box"></span> Ijazah (Hlm. Identitas)</span> <span>${item.l} exp</span></div>
                            <div class="check-item"><span><span class="check-box"></span> Foto Santri (L+TL)</span> <span>${item.total} lbr</span></div>
                            <div class="check-item"><span><span class="check-box"></span> Surat keterangan lulus (SKL)</span> <span>1 exp</span></div>
                            <div class="footer-date">Tanggal EBTAQ: ${ebtaqDate}</div>
                        </div>`;
                }
                pageDiv.appendChild(card);
            });
            while(pageDiv.children.length < 4) {
                const emptyCard = document.createElement('div');
                emptyCard.className = 'label-card';
                pageDiv.appendChild(emptyCard);
            }
            renderArea.appendChild(pageDiv);
        }
        window.print();
    }
</script>
</body>
</html>
